networks:
  redis-net:
    external: true

volumes:
  redis-insight-data:

# RedisInsight with OAuth2 Proxy + Keycloak RBAC
services:
  # OAuth2 Proxy - Keycloak Authentication with Role Control
  redis-oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.13.0
    hostname: redis-oauth2-proxy
    command: --config /oauth2-proxy.cfg
    networks:
      - redis-net
    ports:
      - "0.0.0.0:4180:4180"
    volumes:
      - "./oauth2-config/${OAUTH2_PROXY_CONFIG_FILE:-oauth2-proxy-keycloak.cfg}:/oauth2-proxy.cfg:ro"
      - "./certs:/etc/oauth2-proxy/certs:ro"
      - "./templates:/etc/oauth2-proxy/templates:ro"
    deploy:
      replicas: 1
    depends_on:
      - redis-insight

  # RedisInsight - Redis Admin Interface (Protected by OAuth2 Proxy)
  redis-insight:
    image: redis/redisinsight:2.70
    hostname: redis-insight
    networks:
      - redis-net
    environment:
      RI_LOG_LEVEL: info
      # Disable Redis Insight authentication since OAuth2 Proxy handles it
      RI_APP_TYPE: docker
    volumes:
      - "redis-insight-data:/data"
    deploy:
      replicas: 1
